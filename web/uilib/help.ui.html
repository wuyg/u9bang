<div class="container-fluid">
    <br/>
    <br/>
    <div class="col-md-3">
        <div class="row">
            <div class="col-md-11">
                <div class="row">
                    <!--项目信息以及子页面节点-->
                    <div id="tree_page_list">
                    </div>
                </div>
            </div>
            <div class="col-md-1 resizable-bar">
                
            </div>
        </div>
    </div>
    <div class="col-md-9" role="main">
        <section class="row clearfix" id="page_content_title">
            <h1></h1></section>
        <section class="row clearfix" id="page_content_content">
        </section>
    </div>
</div>
<script>
$(document).ready(function(e) {
    var did = $('#Page_Main_DataID').data('id') || 0;
    Load_PageContent(did)
    Load_PageList(did);
});

function Load_PageContent(id) {
    Fanx.Run('Help_Page_Item_BP', {
        ID: id
    }, function(result, error, e) {
        if (error) {
            Fanx.Error(error);
        } else {
            if (result.su) {
                $('#page_content_title>h1').html(result.data.Title);
                $('#page_content_content').html(result.data.Content);
                
                $('.resizable-bar').css('min-height',$('#page_content_content').height())                
            }
        }
    }, {
        type: "GET"
    });
}

function Load_PageList(id) {
    Fanx.Run('Help_Page_Parents_BP', {
        ID: id
    }, function(result, error, e) {
        if (error) {
            Fanx.Error(error);
        } else {
            if (result.su) {
                for (var i = 0; i < result.data.length; i++) {
                    createPageItemNode(result.data[i], i);
                }
                if (id <= 0 && result.data && result.data.length > 0) {
                    expendTree(result.data[0].ID, result.data[0].ID);
                }
            }
        }
        if (id > 0) {
            SetNodeFocus(id);
        }
    }, {
        type: "GET"
    });
}

function SetNodeFocus(id) {
    $('#tree_page_list>[data-id="' + id + '"]').addClass('active');
}

function NodeItemClick(sender) {
    if (!sender) {
        return false;
    }
    if (!$(sender).data('isrun') || $(sender).data('isrun') == "0") {
        $(sender).data('isrun', "1");
        var c_div = $(sender.parentElement);
        var param = {
            ID: c_div.data('id'),
            Path: c_div.data('path')
        };
        if ($(sender).hasClass('node-toc-collapsed')) {
            expendTree(param.ID);
        } else {
            $('#tree_page_list').find("div[data-path^='" + param.Path + "'][data-path!='" + param.Path + "']").remove();
            $(sender).removeClass('node-toc-expanded').addClass('node-toc-collapsed');

            $(sender).data('isrun', "0");
        }
    }
}

function createPageItemNode(data, i) {
    var html = '',
        param = {
            Path: "0",
            Level: 0
        };
    var parRow = null;
    var box = $('#tree_page_list');
    if (data.Parent && data.Parent > 0) {
        var c_div = box.find('div[data-id="' + data.Parent + '"]');
        param.Level = c_div.data('level') + 1;
        param.Path = c_div.data('path');

        parRow = c_div.next();
    }
    html = '<div class="ind' + (param.Level) + ' node-toc" data-level="' + (param.Level) + '" data-id="' + data.ID + '" data-path="' + param.Path + '-' + i + '">';
    if (data.Total_Child > 0) {
        html += '<a class="node-toc-icon node-toc-collapsed" onclick="NodeItemClick(this)"></a>';
    } else {
        html += '<a class="node-toc-icon"></a>';
    }
    html += '<a class="node-toc-item" href="/help/' + data.ID + '.html">' + data.Title + '</a>';
    html += '</div>';

    if (parRow != null && parRow.length > 0) {
        $(html).insertBefore(parRow);
    } else {
        box.append(html);
    }

    if (data.Parent && data.Parent > 0) {
        $('#tree_page_list>div[data-id="' + data.Parent + '"]>.node-toc-icon').removeClass('node-toc-collapsed').addClass('node-toc-expanded').data('isrun', "0");
    }
}

function expendTree(parent, currID) {
    var param = {
        ID: 0,
        Path: "0",
        Level: 0
    };
    if (parent && parent > 0) {
        var c_div = $('#tree_page_list>div[data-id="' + parent + '"]');
        if (c_div && c_div.length > 0) {
            param.ID = c_div.data('id');
            param.Level = c_div.data('level') + 1;
            param.Path = c_div.data('path');

            $('#tree_page_list').find("div[data-path^='" + param.Path + "'][data-path!='" + param.Path + "']").remove();
        }
    } else {
        $('#tree_page_list').find("div[data-path]").remove();
    }
    Fanx.Run('Help_Page_List_BP', {
        Parent: param.ID
    }, function(result, error, e) {
        if (error) {
            Fanx.Error(error);
        } else {
            if (result.su) {
                if (result.data && result.data.length > 0) {
                    for (var i = 0; i < result.data.length; i++) {
                        createPageItemNode(result.data[i], i);
                    }
                    if (currID && currID > 0) {
                        SetNodeFocus(currID);
                    }
                }
            }
        }
    }, {
        type: "POST"
    });
};
</script>
